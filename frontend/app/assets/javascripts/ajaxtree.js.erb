function AjaxTree(tree, $pane) {
    this.tree = tree;
    this.$pane = $pane;

    // load initial pane!
    var tree_id = this.tree_id_from_hash();

    if (tree_id == null) {
        tree_id = tree.root_tree_id;
    }

    this.tree.setCurrentNode(tree_id);
    this.loadPaneForId(tree_id);
    this.setupHashChange();
}

AjaxTree.prototype.setupHashChange = function() {
    $(window).hashchange($.proxy(this.handleHashChange, this));
};

AjaxTree.prototype.tree_id_from_hash = function() {
    if (!location.hash) {
        return;
    }

    return location.hash.replace(/^#(tree::)?/, "");
};

AjaxTree.prototype.handleHashChange = function(event) {
    var self = this;

    if ($(window).data("ignore-hashchange")) {
        $(window).data("ignore-hashchange", false);
        return false;
    }

    var tree_id = self.tree_id_from_hash();

    if (tree_id == null) {
        return false;
    }

    // TODO Set selected row on tree

    // Load pane
    self.tree.setCurrentNode(tree_id);
    self.loadPaneForId(tree_id);

    return false;
};

AjaxTree.prototype.loadPaneForId = function(tree_id) {
    var self = this;

    // TODO insertLoadingMessage();
    var params = {};
    params.inline = true;
    params[self.tree.root_node_type + '_id'] = self.tree.root_uri;

    var parsed = TreeIds.parse_tree_id(tree_id);
    var row_type = parsed.type;
    var row_id = parsed.id;

    // FIXME: nicer way to get the controller path?
    var url = APP_PATH+row_type + 's' + '/' + row_id;

    if (!self.tree.read_only) {
        url = url + "/edit";
    }

    $.ajax({
        url: url,
        type: 'GET',
        data: params,
        success: function(html) {
            self.$pane.html(html);
            if (!self.tree.read_only) {
                self.setup_ajax_form();
            }
            $(document).trigger("loadedrecordform.aspace", [self.$pane]);
        },
        error: function(obj, errorText, errorDesc) {
            // FIXME I18n message
            $("#object_container").html("<div class='alert alert-error'><p>An error occurred loading this form.</p><pre>"+errorDesc+"</pre></div>");
        }
    });
};


AjaxTree.prototype.setup_ajax_form = function() {
    var self = this;

    var $form = $("form", self.$pane);

    $form.ajaxForm({
        data: {
            inline: true
        },
        beforeSubmit: function(arr, $form) {
            $(".btn-primary", $form).attr("disabled","disabled");

            if ($form.data("createPlusOne")) {
                arr.push({
                    name: "plus_one",
                    value: "true",
                    required: false,
                    type: "text"
                });
            }
        },
        success: function(response, status, xhr) {
            self.$pane.html(response);
            var $form = self.setup_ajax_form();

            if ($form.data('formErrors')) {
                self.$pane.triggerHandler("submitted", {success: false});
                $form.data("form_changed", true);
                $(".btn-primary, .btn-cancel", $form).removeAttr("disabled");
            } else {
                $form.data("form_changed", false);

                self.$pane.triggerHandler("submitted", {success: true});
            }

            if ( $form.data('"update-monitor-paused"') ) {
                $form.data("update-monitor-paused", false);
            }

            // scroll back to the top
            $.scrollTo("header");
        },
        error: function(obj, errorText, errorDesc) {
            // FIXME I18n message
            self.$pane.prepend("<div class='alert alert-error'><p>An error occurred saving this record.</p><pre>"+errorDesc+"</pre></div>");
            self.$pane.triggerHandler("submitted", {success: false});
            $(".btn-primary", $form).removeAttr("disabled");
        }
    });
};
